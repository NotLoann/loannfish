<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LoannFish 1.5</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: monospace;
      background: linear-gradient(180deg, #1a1a1a, #3b3b3b); /* Fond sombre */
      color: white; /* Texte blanc par défaut */
      overflow: hidden;
    }

    .hidden { display: none; }

    #menu, #howToPlay, #game, #shop-screen {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      text-align: center;
      position: relative; /* Pour positionner les éléments internes */
    }

    #menu {
        display: flex;
        background: linear-gradient(180deg, #1a1a1a, #3b3b3b); /* Retour au fond dégradé statique */
    }

    #menu h1 {
      font-size: 64px;
      text-shadow: 2px 2px #000;
      animation: none; /* Désactive toutes les animations */
    }

    .menu-btn, button {
      margin-top: 20px;
      padding: 12px 24px;
      font-size: 18px;
      background: white; /* Boutons blancs */
      color: black; /* Texte noir sur les boutons */
      border: none;
      cursor: pointer;
      border-radius: 5px;
      transition: transform 0.2s, box-shadow 0.2s, background 0.2s, color 0.2s; /* Transition pour toutes les propriétés */
      box-shadow: 0 0 10px rgba(255,255,255,0.5); /* Ombre blanche pour les boutons */
      position: relative; /* Pour les pseudo-éléments d'animation */
      overflow: hidden; /* Pour cacher l'effet de lumière */
      z-index: 1;
    }

    #menu .menu-btn, #menu button {
      animation: none; /* Désactive l'animation de pulsation */
    }

    .menu-btn:hover, button:hover {
      transform: scale(1.05);
      background: #eee; /* Léger changement de couleur au survol */
      box-shadow: 0 0 15px rgba(255,255,255,0.8), 0 0 25px rgba(255,255,255,0.6); /* Glow plus intense */
    }

    /* Effet de balayage lumineux au survol des boutons */
    .menu-btn::before, button::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        transition: left 0.5s ease-in-out;
        z-index: -1;
    }

    .menu-btn:hover::before, button:hover::before {
        left: 100%;
    }


    #howToPlay p {
        max-width: 600px;
        margin: 20px auto;
        line-height: 1.6;
        font-size: 1.1em;
    }

    #howToPlay h2, #shop-screen h2 {
        font-size: 3em;
        margin-bottom: 30px;
        color: white; /* Titres du shop et howto en blanc sur fond dégradé */
    }

    #result {
      font-size: 24px;
      margin-top: 20px;
      height: 40px;
      text-shadow: 2px 2px #000;
      animation: pop 0.3s ease-out;
    }

    @keyframes pop {
      0% { transform: scale(0.5); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }

    #xpDisplay {
      margin-top: 15px;
      font-size: 18px;
      color: #FFD700;
      text-shadow: 2px 2px #000;
    }

    #moneyDisplayTopRight {
        position: absolute;
        top: 20px;
        right: 20px;
        font-size: 20px;
        color: #39FF14; /* Vert néon pour l'argent */
        text-shadow: 0 0 5px #39FF14, 0 0 10px #39FF14, 0 0 15px #39FF14; /* Effet glow */
        font-weight: bold;
    }

    .level-up-animation {
      animation: levelUpAnimation 0.8s ease-out forwards;
    }

    @keyframes levelUpAnimation {
      0% { transform: scale(1); text-shadow: 0 0 5px #FFD700; }
      50% { transform: scale(1.2); text-shadow: 0 0 20px #FFD700, 0 0 30px #FFD700; }
      100% { transform: scale(1); text-shadow: 0 0 5px #FFD700; }
    }

    #collection {
      margin-top: 30px;
      padding: 10px;
      background: rgba(255,255,255,0.1);
      border: 1px solid white;
      width: 350px;
      min-height: 60px;
      color: white;
      overflow-y: auto;
      max-height: 200px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); /* Ombre pour faire ressortir */
    }

    #collection ul, #shop-content-sell ul {
        list-style: none;
        padding: 0;
    }
    #collection li, #shop-content-sell li {
        margin-bottom: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap; /* Permet aux éléments de passer à la ligne si pas assez de place */
        color: white; /* Texte des items du shop en blanc */
    }
    
    /* Styles spécifiques pour la liste d'achat */
    #shop-content-buy ul {
        list-style: none;
        padding: 0;
        width: 100%; /* S'assure que la liste prend toute la largeur du conteneur */
    }

    #shop-content-buy li {
        margin-bottom: 8px; /* Réduire l'espace entre les items */
        display: flex;
        flex-wrap: nowrap; /* Empêche le retour à la ligne pour un affichage compact */
        align-items: center;
        justify-content: space-between; /* Pour pousser le bouton à droite */
        background: rgba(255,255,255,0.1); /* Augmenter l'opacité du fond pour les items du shop */
        padding: 8px 12px; /* Réduire le padding pour plus d'espace */
        border-radius: 8px; /* Arrondir un peu plus les bords */
        border: 1px solid rgba(255,255,255,0.2); /* Bordure légère */
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3); /* Ombre légère pour la profondeur */
    }

    #shop-content-buy li .item-info-container {
        display: flex;
        flex-direction: column; /* Empiler nom et description */
        align-items: flex-start;
        flex-grow: 1; /* Permet au texte de prendre l'espace disponible */
        text-align: left; /* Aligner le texte à gauche */
        margin-right: 10px; /* Réduire l'espace entre info et bouton */
        overflow: hidden; /* Cache le texte qui dépasse */
    }

    #shop-content-buy li .item-info-container span:first-child {
        font-weight: bold;
        font-size: 1em; /* Réduire la taille du nom */
        margin-bottom: 2px; /* Réduire l'espace entre nom et description */
        white-space: nowrap; /* Garde le nom sur une seule ligne */
        overflow: hidden;
        text-overflow: ellipsis; /* Ajoute des points de suspension si le texte est trop long */
    }
    #shop-content-buy li .item-info-container span:last-child {
        font-size: 0.8em; /* Réduire la taille de la description */
        color: #bbb; /* Couleur plus claire pour la description */
        white-space: nowrap; /* Garde la description sur une seule ligne */
        overflow: hidden;
        text-overflow: ellipsis; /* Ajoute des points de suspension si le texte est trop long */
    }

    #shop-content-buy li .item-action {
        display: flex; /* Permet d'aligner le prix et le bouton */
        align-items: center;
        gap: 10px; /* Réduire l'espace entre le prix et le bouton */
    }
    #shop-content-buy li .item-action span {
        font-size: 1em; /* Réduire la taille du prix */
        font-weight: bold;
        color: #39FF14; /* Vert néon pour le prix */
        text-shadow: 0 0 5px #39FF14;
    }


    #shop-content-sell li span, #shop-content-buy li .item-info-container {
        margin-right: 10px;
    }

    #shop-content-sell li input {
        width: 50px; /* Largeur pour l'input de quantité */
        padding: 5px;
        margin-right: 5px;
        border: 1px solid #ccc;
        border-radius: 3px;
        background: #333; /* Fond sombre pour les inputs */
        color: white; /* Texte blanc dans les inputs */
    }

    #shop-screen {
        width: 100%;
        height: 100%;
        background: linear-gradient(180deg, #1a1a1a, #3b3b3b); /* Fond dégradé comme le menu */
        color: white; /* Texte par défaut du shop en blanc */
        padding: 0;
        box-shadow: none;
        /* overflow-y: auto; <-- Géré par le conteneur interne pour le scroll */
    }

    /* Le contenu du shop est maintenant directement dans #shop-screen, sans background spécifique */
    #shop-items-container { /* Conteneur pour les sections Sell et Buy */
        margin-top: 20px;
        width: 100%;
        max-width: 700px; /* Augmenter la largeur maximale pour plus d'espace */
        padding: 0 20px; /* Ajoute un peu de padding pour éviter que le contenu ne touche les bords */
        box-sizing: border-box; /* Inclut le padding dans la largeur */
        display: flex;
        flex-direction: column;
        align-items: center;
        flex-grow: 1; /* Permet au conteneur de prendre l'espace disponible */
        overflow-y: auto; /* Ajoute un défilement UNIQUEMENT à ce conteneur */
        max-height: calc(100vh - 250px); /* Ajuster cette valeur pour laisser de la place au titre, aux boutons de navigation et au bouton "Back" */
        padding-bottom: 20px; /* Padding en bas du conteneur scrollable */
    }

    #shop-items-container p { /* Texte "Sell your items here!" / "Buy your items here!" */
        color: white;
        text-align: center;
        width: 100%;
        margin-bottom: 20px; /* Plus d'espace sous le paragraphe d'intro */
    }

    #shop-items-container h3 {
        color: white;
        margin-top: 30px;
        margin-bottom: 15px;
        font-size: 1.8em; /* Rendre les sous-titres plus grands */
        border-bottom: 2px solid rgba(255,255,255,0.3); /* Ligne de séparation */
        padding-bottom: 10px;
        width: 100%;
        text-align: center; /* Centrer le texte des sous-titres */
    }

    #shop-content-sell, #shop-content-buy {
        width: 100%;
    }

    #shop-content-sell button {
        margin-left: 10px;
        margin-top: 0;
        padding: 5px 10px;
        font-size: 0.9em;
        background: #4CAF50;
        color: white;
        box-shadow: 0 0 5px #4CAF50;
    }
    #shop-content-sell button:hover {
        box-shadow: 0 0 10px #4CAF50;
    }

    #shop-content-buy button {
        margin-left: 0; /* Important, géré par le gap parent */
        margin-top: 0;
        padding: 8px 15px; /* Réduire la taille des boutons d'achat */
        font-size: 0.9em; /* Taille de police légèrement plus petite */
        background: #007bff; /* Bleu pour les boutons d'achat */
        color: white;
        box-shadow: 0 0 5px #007bff;
        border-radius: 5px;
    }
    #shop-content-buy button:hover {
        box-shadow: 0 0 10px #007bff;
    }
    #shop-content-buy button:disabled {
        background: #6c757d; /* Gris pour les boutons désactivés */
        box-shadow: none;
        cursor: not-allowed;
    }

    .game-buttons button:disabled {
        background: #6c757d; /* Gris pour les boutons désactivés */
        box-shadow: none;
        cursor: not-allowed;
    }

    .shop-menu-buttons {
        display: flex;
        gap: 20px;
        margin-bottom: 30px; /* Plus d'espace sous les boutons de navigation du shop */
    }

    .shop-menu-buttons button {
        padding: 10px 20px;
        font-size: 1.1em;
    }

    .game-buttons {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 20px;
    }

    .game-buttons button {
        margin-top: 10px;
    }

    /* Correction du style pour le bouton "Back" du shop */
    #shop-screen .menu-btn { 
        margin-top: 30px; /* Ajoute une marge au-dessus */
        margin-bottom: 30px; /* Ajoute une marge en bas */
        align-self: center; /* Assure qu'il est centré même avec un auto margin-top */
    }

    #reset-button-menu {
        position: absolute;
        bottom: 20px;
        left: 20px;
        background: #cc0000;
        color: white;
        box-shadow: none; /* Supprime l'ombre */
        animation: none; /* Supprime toute animation */
    }

    #reset-button-menu:hover {
        transform: scale(1.05);
        box-shadow: none; /* Assure qu'il n'y a pas d'ombre au survol */
    }

    .animation-line {
      width: 6px;
      height: 120px;
      background: linear-gradient(to top, white, transparent);
      margin-top: 20px;
      border-radius: 2px;
      animation: pull 1s infinite ease-in-out;
    }

    @keyframes pull {
      0%, 100% { transform: scaleY(1) rotate(0deg); }
      25% { transform: scaleY(1.2) rotate(-5deg); }
      50% { transform: scaleY(0.9) rotate(3deg); }
      75% { transform: scaleY(1.1) rotate(-2deg); }
    }

    .bubble {
      position: absolute;
      bottom: -50px;
      width: 10px;
      height: 10px;
      background: rgba(255, 255, 255, 0.5); /* Bulles blanches pour le fond sombre */
      border-radius: 50%;
      animation: rise 8s infinite ease-in;
    }

    @keyframes rise {
      0% { transform: translateY(0) scale(1); opacity: 1; }
      100% { transform: translateY(-120vh) scale(0.5); opacity: 0; }
    }

    #hook-display {
      margin-top: 10px;
      font-size: 16px;
      color: #add8e6; /* Bleu clair pour l'hameçon */
      text-shadow: 1px 1px #000;
      position: absolute;
      bottom: 20px;
      left: 20px;
      flex-direction: column;
      align-items: flex-start;
      padding: 10px;
      background: rgba(0,0,0,0.3);
      border-radius: 5px;
      min-width: 150px;
      display: none; /* Toujours masqué par défaut dans le CSS */
    }
    #hook-display p {
        margin: 0 0 5px 0;
    }

    #fish-spam-message {
        color: red;
        font-weight: bold;
        margin-top: 10px;
        display: none; /* Caché par défaut */
    }
  </style>
</head>
<body>
  <audio id="bg-music" src="ressources/background.mp3" loop></audio>

  <div id="menu">
    <h1>Loann's Fishing Place</h1>
    <h2>You want something? Fish for it.</h2>
    <button class="menu-btn" onclick="startGame()">Start Fishing!</button>
    <button class="menu-btn" onclick="showHowToPlay()">How To Play</button>
    <h4>Made by NotLoann. Suffering purposes only.</h4>
    <button id="reset-button-menu" onclick="resetGame()">Reset Progression</button>
  </div>

  <div id="howToPlay" class="hidden">
    <h2>How To Play</h2>
    <p>Welcome to The Fishing Website! Your goal is simple: fish for unique items and gain experience to level up. The rarer your catch, the more XP you earn!</p>
    <p><strong>Fishing:</strong> Click the "Fish!" button to cast your line. After a short delay, you'll see what you've caught. Keep an eye on your XP bar!</p>
    <p><strong>Rarity:</strong> Items have star ratings, from 1 to 5 stars, indicating their rarity.</p>
    <p><strong>Collection:</strong> All your unique catches are added to your collection. Try to find them all!</p>
    <p><strong>XP & Leveling:</strong> Each catch (except "Nothing...") grants you XP. Collect enough XP to reach the next level. Higher levels might unlock new possibilities (hint, hint!).</p>
    <p><strong>Shop:</strong> Visit the shop to sell your collected items for money! Different items have different values. You can also <strong>buy special items</strong> to improve your fishing!</p>
    <button class="menu-btn" onclick="showMenu()">Back to Menu</button>
  </div>

  <div id="shop-screen" class="hidden">
    <h2>Shop</h2>
    <div class="shop-menu-buttons">
        <button onclick="showSellTab()">Sell Items</button>
        <button onclick="showBuyTab()">Buy Items</button>
    </div>
    <div id="shop-items-container">
        <div id="shop-content-sell">
            <h3>Sell Your Items</h3>
            <p>Sell your fish and other items here!</p>
            <ul id="sell-list"></ul>
        </div>
        <div id="shop-content-buy" class="hidden">
            <h3>Buy Items & Equip Hooks</h3>
            <p>Purchase powerful items to improve your fishing experience!</p>
            <ul id="buy-list"></ul>
        </div>
    </div>
    <button class="menu-btn" onclick="startGame()">Back</button>
  </div>


  <div id="game" class="hidden">
    <div id="moneyDisplayTopRight">Money: $0</div> 
    <h1>🎣 The Fishing Place 1</h1>
    <button id="fish-button" onclick="fish()">Fish!</button>
    <div id="fish-spam-message"></div> 
    <div class="animation-line" id="rod" style="display:none;"></div>
    <div id="result"></div>
    <div id="xpDisplay"></div> 
    <div id="collection">
      <strong>Your collection:</strong>
      <ul id="list"></ul>
    </div>
    <div id="hook-display">
        <p>Equipped Hook: <span id="current-hook">None</span></p>
        <p>Equipped Rod: <span id="current-rod">None</span></p>
    </div>
    <div class="game-buttons">
        <button class="menu-btn" onclick="showShop()">Shop</button>
        <button class="menu-btn" onclick="showMenu()">Back to Menu</button>
    </div>
  </div>

  <script>
    // --- Configuration Constants ---
    const GAME_CONFIG = {
        XP_BASE_THRESHOLD: 50,
        XP_LEVEL_MULTIPLIER: 1.5,
        FISHING_BASE_TIME_MS: 2000,
        SPAM_MESSAGE_DURATION_MS: 1500
    };

    const TEXT_LABELS = {
        TOO_EXPENSIVE: "Too Expensive",
        EQUIPPED: "Equipped",
        EQUIP: "Equip",
        UNEQUIP: "Unequip",
        NO_HOOK_DESC: "(Unequip your current hook.)",
        NO_ROD_DESC: "(Unequip your current rod.)",
        SPAM_MESSAGE: "Please wait for the animation before clicking again!"
    };


const fishes = [

  // --- Very Common / Beach Debris and Small Organisms (1 Star) ---
  { name: "🥫 Rusty Soda Can", rarity: 15, stars: 1, xp: 5, price: 2 },
  { name: "🛍️ Plastic Bag", rarity: 14, stars: 1, xp: 4, price: 1 },
  { name: "🎣 Tangled Fishing Line", rarity: 13, stars: 1, xp: 6, price: 3 },
  { name: "👟 Single Flip-Flop", rarity: 12, stars: 1, xp: 7, price: 4 },
  { name: "🗑️ Bottle Cap", rarity: 11, stars: 1, xp: 3, price: 1 },
  { name: "🦀 Small Common Crab", rarity: 10, stars: 1, xp: 10, price: 6 },
  { name: "🪙 Old Coin", rarity: 9, stars: 1, xp: 12, price: 7 },
  { name: "🐦 Seagull Feather", rarity: 8, stars: 1, xp: 6, price: 3 },
  { name: "🪱 Beach Worm", rarity: 7, stars: 1, xp: 7, price: 3 },
  { name: "🐚 Intact Common Seashell", rarity: 6, stars: 1, xp: 7, price: 3 },
  { name: "🐟 Small Fish Anchovy/Sardine", rarity: 5, stars: 1, xp: 10, price: 6 },
  { name: "🌱 Seagrass Shoots", rarity: 4, stars: 1, xp: 5, price: 2 },
  { name: "🪢 Short Nautical Rope", rarity: 3, stars: 1, xp: 6, price: 3 },
  { name: "🧽 Natural Sea Sponge", rarity: 2.5, stars: 1, xp: 4, price: 2 },
  { name: "🪨 Common Coral Piece", rarity: 2, stars: 1, xp: 8, price: 4 },

  // --- Uncommon (2 Stars) ---
  { name: "🐠 Juvenile Clownfish", rarity: 8, stars: 2, xp: 25, price: 15 },
  { name: "👟 Old Water Shoe", rarity: 7, stars: 2, xp: 28, price: 12 },
  { name: "🦀 Small Lobster", rarity: 6.5, stars: 2, xp: 35, price: 20 },
  { name: "🦴 Large Fish Bone", rarity: 6, stars: 2, xp: 24, price: 9 },
  { name: "🔑 Rusty Locker Key", rarity: 5.5, stars: 2, xp: 30, price: 18 },
  { name: "📜 Message in a Bottle Readable", rarity: 5, stars: 2, xp: 40, price: 25 },
  { name: "🐠 Common Tropical Fish", rarity: 4.8, stars: 2, xp: 32, price: 20 },
  { name: "🤿 Cracked Snorkel Mask", rarity: 4.5, stars: 2, xp: 30, price: 16 },
  { name: "🐚 Intact Nautilus Shell", rarity: 3.6, stars: 2, xp: 45, price: 30 },
  { name: "🦞 Small Spiny Lobster", rarity: 3.4, stars: 2, xp: 50, price: 35 },
  { name: "📷 Old Waterproof Camera no film", rarity: 3.2, stars: 2, xp: 42, price: 28 },
  { name: "🐙 Baby Octopus", rarity: 2.8, stars: 2, xp: 40, price: 25 },
  { name: "🦀 Hermit Crab with pretty shell", rarity: 2.2, stars: 2, xp: 42, price: 28 },
  { name: "🐠 Juvenile Angelfish", rarity: 2, stars: 2, xp: 48, price: 30 },
  { name: "🌟 Common Colored Sea Glass", rarity: 1, stars: 2, xp: 28, price: 12 },
  { name: "🐚 Dried Starfish", rarity: 0.8, stars: 2, xp: 30, price: 15 },
  { name: "🐡 Adult Perch", rarity: 0.6, stars: 2, xp: 38, price: 22 },
  { name: "🦑 Small Squid", rarity: 0.4, stars: 2, xp: 40, price: 25 },

  // --- Rare (3 Stars) ---
  { name: "🐠 Colorful Parrotfish", rarity: 3, stars: 3, xp: 50, price: 40 },
  { name: "🦀 Juvenile King Crab", rarity: 2.8, stars: 3, xp: 55, price: 45 },
  { name: "🕰️ Sunken Pocket Watch", rarity: 2.5, stars: 3, xp: 60, price: 50 },
  { name: "🧭 Old Ship Compass", rarity: 2.3, stars: 3, xp: 65, price: 55 },
  { name: "💎 Small Amber Piece", rarity: 2.1, stars: 3, xp: 70, price: 60 },
  { name: "🐢 Baby Sea Turtle", rarity: 1.1, stars: 3, xp: 90, price: 80 },
  { name: "🐬 Worn Dolphin Toy", rarity: 1, stars: 3, xp: 85, price: 75 },
  { name: "🐚 Giant Conch Shell", rarity: 0.9, stars: 3, xp: 95, price: 85 },
  { name: "🦈 Curious Baby Shark", rarity: 0.8, stars: 3, xp: 100, price: 90 },
  { name: "⚓ Small Ship's Anchor", rarity: 0.35, stars: 3, xp: 115, price: 105 },
  { name: "🐟 Juvenile Sunfish", rarity: 0.3, stars: 3, xp: 120, price: 110 },
  { name: "💎 Geode with Sea Crystals", rarity: 0.15, stars: 3, xp: 130, price: 120 },
  { name: "🌟 Rare Colored Sea Glass", rarity: 0.09, stars: 3, xp: 110, price: 100 },
  { name: "🐙 Juvenile Giant Pacific Octopus", rarity: 0.08, stars: 3, xp: 150, price: 140 },
  { name: "🐠 Royal Gramma Fish", rarity: 0.03, stars: 3, xp: 130, price: 120 },
  { name: "🚤 Working Toy Speedboat", rarity: 0.01, stars: 3, xp: 150, price: 140 },

  // --- Very Rare (4 Stars) ---
  { name: "🐠 Regal Tang", rarity: 1, stars: 4, xp: 180, price: 160 },
  { name: "📦 Empty Sunken Treasure Chest", rarity: 0.9, stars: 4, xp: 190, price: 170 },
  { name: "🗺️ Partial Ancient Mariner's Chart", rarity: 0.7, stars: 4, xp: 210, price: 190 },
  { name: "⚓ Small Old Shipwreck Anchor", rarity: 0.4, stars: 4, xp: 240, price: 220 },
  { name: "👑 Chipped Coral Crown", rarity: 0.3, stars: 4, xp: 260, price: 240 },
  { name: "🔑 Captain's Cabin Key", rarity: 0.28, stars: 4, xp: 270, price: 250 },
  { name: "🌟 Glowing Starfish", rarity: 0.12, stars: 4, xp: 330, price: 310 },
  { name: "🐠 Lionfish", rarity: 0.06, stars: 4, xp: 370, price: 350 },
  { name: "💎 Barnacle-Crusted Emerald Amulet", rarity: 0.045, stars: 4, xp: 390, price: 370 },
  { name: "🛡️ Decorative Coral Shield", rarity: 0.035, stars: 4, xp: 410, price: 390 },
  { name: "🧳 Waterproof Captain's Logbook", rarity: 0.02, stars: 4, xp: 440, price: 420 },
  { name: "🐚 Pearl Oyster with large pearl", rarity: 0.012, stars: 4, xp: 470, price: 450 },
  { name: "🌊 Trophy Size Giant Bluefin Tuna", rarity: 0.009, stars: 4, xp: 490, price: 470 },
  { name: "🦀 Very Large Coconut Crab", rarity: 0.008, stars: 4, xp: 500, price: 480 },
  { name: "🎣 Golden Lure", rarity: 0.006, stars: 4, xp: 520, price: 500 },

  // --- Legendary (5 Stars) ---

  { name: "🪙 Perfectly Preserved Gold Coin", rarity: 0.25, stars: 5, xp: 600, price: 550 },
  { name: "👑 Miniature Crown", rarity: 0.15, stars: 5, xp: 700, price: 650 },
  { name: "🗺️ Complete Map to Atlantis", rarity: 0.05, stars: 5, xp: 1000, price: 950 },
  { name: "🗿 Deep Sea Variant Moai Head", rarity: 0.04, stars: 5, xp: 1100, price: 1050 },
  { name: "🔑 Master Key of the Deep", rarity: 0.03, stars: 5, xp: 1200, price: 1150 },
  { name: "🔭 Abyssal Telescope", rarity: 0.025, stars: 5, xp: 1250, price: 1200 },
  { name: "💎 Petrified Kraken's Eye", rarity: 0.012, stars: 5, xp: 1450, price: 1400 },
  { name: "🌟 Pulsating Star Coral", rarity: 0.01, stars: 5, xp: 1500, price: 1450 },
  { name: "📜 Sealed Poseidon's Decree", rarity: 0.009, stars: 5, xp: 1550, price: 1500 },
  { name: "🐠 Living Fossil Coelacanth", rarity: 0.006, stars: 5, xp: 1700, price: 1650 },

  // --- Unique (6 Stars) - Ultimate Summer Treasures ---
  { name: "🐡 Trophy Fish", rarity: 0.003, stars: 6, xp: 2000, price: 20000 },
];

    const shopItems = [
        // Hooks (Type: hook)
        
        
        
        
        // Rod (Type: rod - un équipement comme les hooks)
        { id: 'basic_hook', name: 'Basic Hook', price: 500, type: 'hook', speedBonus: 0.10, description: "+10% fishing speed." },
        { id: 'basic_rod', name: 'Basic Fishing Rod', price: 850, type: 'rod', speedBonus: 0.20, description: "+20% fishing speed." },
        { id: 'advanced_hook', name: 'Advanced Hook', price: 2000, type: 'hook', speedBonus: 0.30, description: "+30% fishing speed" },
        { id: 'advanced_rod', name: 'Advanced Fishing Rod', price: 3000, type: 'hook', speedBonus: 0.40, description: "+40% fishing speed" },
        { id: 'master_hook', name: 'Master Hook', price: 5000, type: 'hook', speedBonus: 0.60, description: "+60% fishing speed" },
        { id: 'master_anglers_rod', name: 'Master Angler\'s Rod', price: 8000, type: 'rod', speedBonus: 0.20, rareChanceBonus: { stars: 4, bonus: 0.15 }, description: "+20% fishing speed & +15% luck" },
        { id: 'blessed_hook', name: 'Blessed Hook', price: 11000, type: 'hook', rareChanceBonus: { stars: 4, bonus: 0.5 }, description: "+50% luck" }
    ];

    // --- Game State Object ---
    const gameState = {
        collection: [],
        xp: 0,
        level: 1,
        money: 0,
        ownedItems: [], 
        equippedHook: null, 
        equippedRod: null, 
        isFishing: false 
    };

    const bgMusic = document.getElementById('bg-music');
    const fishButton = document.getElementById('fish-button');
    const fishSpamMessage = document.getElementById('fish-spam-message');

    function showScreen(screenId) {
        // Hide ALL main screens
        document.getElementById('menu').style.display = 'none';
        document.getElementById('howToPlay').style.display = 'none';
        document.getElementById('game').style.display = 'none';
        document.getElementById('shop-screen').style.display = 'none';
        
        // Hide equipment display by default
        document.getElementById('hook-display').style.display = 'none'; 

        // Show the requested screen
        document.getElementById(screenId).style.display = 'flex';

        // If the game screen is activated, then the equipment display is needed
        if (screenId === 'game') {
            document.getElementById('hook-display').style.display = 'flex';
        }
    }

    function showMenu() {
        showScreen('menu');
        bgMusic.pause(); // Pause music if returning to main menu
        bgMusic.currentTime = 0; // Reset to beginning
    }

    function showHowToPlay() {
        showScreen('howToPlay');
    }

    // Renommée de showGame() à startGame() pour correspondre à l'onclick initial
    function startGame() { 
      showScreen('game');
      // Load and update are now part of startGame for consistency, ensuring they run when game starts/resumes
      loadCollection(); 
      updateHookDisplay(); 
      if (bgMusic.paused) {
          bgMusic.play().catch(e => console.log("Autoplay music blocked: ", e));
      }
    }

    function showShop() {
        showScreen('shop-screen');
        showSellTab(); // By default, show "Sell Items" tab
    }

    function showSellTab() {
        document.getElementById('shop-content-sell').classList.remove('hidden');
        document.getElementById('shop-content-buy').classList.add('hidden');
        updateShopList();
    }

    function showBuyTab() {
        document.getElementById('shop-content-buy').classList.remove('hidden');
        document.getElementById('shop-content-sell').classList.add('hidden');
        updateBuyList();
    }

    function hasTrophyFish() {
      return gameState.collection.includes("🐡 Trophy Fish");
    }

    function drawFish() {
        let currentFishes = JSON.parse(JSON.stringify(fishes)); // Deep copy for modification

        // Apply effects of owned items
        let noCatchReductionTotal = 0;
        let rareChanceBonus3Stars = 0;
        let rareChanceBonus4Stars = 0;

        // Only 'rod' type items alter fishing effects
        gameState.ownedItems.forEach(itemId => {
            const item = shopItems.find(i => i.id === itemId && i.type === 'item');
            if (item && item.effect) {
                if (item.effect.noCatchReduction) {
                    noCatchReductionTotal += item.effect.noCatchReduction;
                }
                if (item.effect.rareChanceBonus) {
                    if (item.effect.rareChanceBonus.stars === 3) rareChanceBonus3Stars += item.effect.rareChanceBonus.bonus;
                    if (item.effect.rareChanceBonus.stars === 4) rareChanceBonus4Stars += item.effect.rareChanceBonus.bonus;
                }
            }
        });

        // Apply effects of equipped rod
        if (gameState.equippedRod) {
            const rod = shopItems.find(i => i.id === gameState.equippedRod && i.type === 'rod');
            if (rod && rod.rareChanceBonus) {
                if (rod.rareChanceBonus.stars === 3) rareChanceBonus3Stars += rod.rareChanceBonus.bonus;
                if (rod.rareChanceBonus.stars === 4) rareChanceBonus4Stars += rod.rareChanceBonus.bonus;
            }
        }

        // Adjust rarity of "Nothing..."
        const nothingIndex = currentFishes.findIndex(f => f.name === "🌊 Nothing...");
        if (nothingIndex !== -1) {
            currentFishes[nothingIndex].rarity = Math.max(0, fishes[nothingIndex].rarity * (1 - noCatchReductionTotal));
        }

        // Adjust rarity of rare fish
        currentFishes.forEach(f => {
            if (f.stars >= 3) {
                f.rarity *= (1 + rareChanceBonus3Stars);
            }
            if (f.stars >= 4) {
                f.rarity *= (1 + rareChanceBonus4Stars);
            }
        });

        let list = currentFishes.filter(f => hasTrophyFish() ? f.name !== "🌊 Nothing..." : true);
        let total = list.reduce((acc, f) => acc + f.rarity, 0);
        let rand = Math.random() * total;
        for (let f of list) {
            if (rand < f.rarity) return f;
            rand -= f.rarity;
        }
        return list[0];
    }

    function fish() {
      if (gameState.isFishing) {
          fishSpamMessage.innerText = TEXT_LABELS.SPAM_MESSAGE; // Set the message text
          fishSpamMessage.style.display = 'block'; // Show message
          setTimeout(() => {
              fishSpamMessage.style.display = 'none'; // Hide message after a short delay
          }, GAME_CONFIG.SPAM_MESSAGE_DURATION_MS);
          return; // Prevent re-fishing
      }

      gameState.isFishing = true; // Set fishing state to true
      fishButton.disabled = true; // Disable button
      fishSpamMessage.style.display = 'none'; // Ensure message is hidden at start of fishing

      const result = document.getElementById("result");
      const rod = document.getElementById("rod");
      result.innerText = "...";
      rod.style.display = "block";

      let fishingTime = GAME_CONFIG.FISHING_BASE_TIME_MS; // Base fishing time
      let totalSpeedBonus = 0;

      if (gameState.equippedHook) {
          const hook = shopItems.find(h => h.id === gameState.equippedHook && h.type === 'hook');
          if (hook) {
              totalSpeedBonus += hook.speedBonus;
          }
      }
      if (gameState.equippedRod) {
          const rodItem = shopItems.find(r => r.id === gameState.equippedRod && r.type === 'rod');
          if (rodItem) {
              totalSpeedBonus += rodItem.speedBonus;
          }
      }
      fishingTime = fishingTime * (1 - totalSpeedBonus);


      setTimeout(() => {
        rod.style.display = "none";
        const catchResult = drawFish();
        result.innerHTML = `${catchResult.name} ${'★'.repeat(catchResult.stars)}`;
        if (catchResult.name !== "🌊 Nothing...") {
          gameState.collection.push(catchResult.name);
          
          let xpEarned = catchResult.xp;
          // 'fishing_guide' item is no longer purchasable, but code remains for old saves
          const fishingGuide = gameState.ownedItems.find(id => id === 'fishing_guide');
          if (fishingGuide) {
              const guideItem = shopItems.find(item => item.id === 'fishing_guide');
              if(guideItem) xpEarned *= (1 + guideItem.effect.xpBonus); 
          }
          addXP(xpEarned);
          saveCollection();
          updateCollection();
        }
        gameState.isFishing = false; // Reset fishing state
        fishButton.disabled = false; // Re-enable button
      }, fishingTime);
    }

    function updateXpLevelDisplay() {
        const xpDisplay = document.getElementById("xpDisplay");
        const threshold = Math.floor(GAME_CONFIG.XP_BASE_THRESHOLD * Math.pow(GAME_CONFIG.XP_LEVEL_MULTIPLIER, gameState.level - 1));
        xpDisplay.innerText = `Level ${gameState.level} - XP: ${gameState.xp}/${threshold}`;
    }

    function updateMoneyDisplay() {
        document.getElementById("moneyDisplayTopRight").innerText = `Money: $${gameState.money}`;
    }

    function addXP(amount) {
      gameState.xp += amount;
      let threshold = Math.floor(GAME_CONFIG.XP_BASE_THRESHOLD * Math.pow(GAME_CONFIG.XP_LEVEL_MULTIPLIER, gameState.level - 1));
      let leveledUp = false;

      while (gameState.xp >= threshold) {
        gameState.xp -= threshold;
        gameState.level++;
        threshold = Math.floor(GAME_CONFIG.XP_BASE_THRESHOLD * Math.pow(GAME_CONFIG.XP_LEVEL_MULTIPLIER, gameState.level - 1));
        leveledUp = true;
      }
      updateXpLevelDisplay();

      if (leveledUp) {
        document.getElementById("xpDisplay").classList.add("level-up-animation");
        setTimeout(() => {
          document.getElementById("xpDisplay").classList.remove("level-up-animation");
        }, 800);
      }
    }

    function sellItem(itemName, quantityId) {
        const quantityInput = document.getElementById(quantityId);
        let quantity = parseInt(quantityInput.value);

        if (isNaN(quantity) || quantity <= 0) {
            alert("Please enter a valid quantity to sell.");
            return;
        }

        const itemToSell = fishes.find(f => f.name === itemName);
        if (!itemToSell) return;

        let itemsSold = 0;
        let totalMoneyEarned = 0;
        for (let i = 0; i < quantity; i++) {
            const index = gameState.collection.indexOf(itemName);
            if (index > -1) {
                gameState.collection.splice(index, 1);
                totalMoneyEarned += itemToSell.price;
                itemsSold++;
            } else {
                break;
            }
        }

        if (itemsSold > 0) {
            // 'lucky_charm' item is no longer purchasable, but code remains for old saves
            const luckyCharm = gameState.ownedItems.find(id => id === 'lucky_charm');
            if (luckyCharm) {
                const charmItem = shopItems.find(item => item.id === 'lucky_charm');
                if(charmItem) totalMoneyEarned *= (1 + charmItem.effect.moneyBonus); 
            }
            gameState.money += Math.round(totalMoneyEarned); // Round money earned
            saveCollection();
            updateCollection();
            updateShopList();
            updateMoneyDisplay();
        } else {
            alert(`You don't have any ${itemName} left to sell.`);
        }
    }

    // Function to handle buying AND equipping items
    function handleItemAction(itemId) {
        const item = shopItems.find(i => i.id === itemId);
        
        // Specific case for "No Hook Equipped" or "No Rod Equipped"
        if (itemId === 'no_hook') { 
            if (gameState.equippedHook !== null) {
                gameState.equippedHook = null;
                alert("You unequipped your hook.");
            } else {
                alert("No hook is currently equipped.");
            }
            saveCollection();
            updateMoneyDisplay();
            updateBuyList();
            updateHookDisplay();
            return;
        } else if (itemId === 'no_rod') {
            if (gameState.equippedRod !== null) {
                gameState.equippedRod = null;
                alert("You unequipped your rod.");
            } else {
                alert("No rod is currently equipped.");
            }
            saveCollection();
            updateMoneyDisplay();
            updateBuyList();
            updateHookDisplay();
            return;
        }

        if (!item) { 
            console.error("Item not found:", itemId);
            return;
        }

        const hasItem = gameState.ownedItems.includes(item.id);
        
        if (item.type === 'hook') {
            const isEquipped = gameState.equippedHook === item.id;
            if (!hasItem) { // Buy the hook
                if (gameState.money >= item.price) {
                    gameState.money -= item.price;
                    gameState.ownedItems.push(item.id);
                    gameState.equippedHook = item.id; // Equip it automatically on purchase
                    alert(`You bought and equipped the ${item.name}!`);
                } else {
                    alert("Not enough money!");
                }
            } else if (isEquipped) { // Unequip if already equipped
                gameState.equippedHook = null;
                alert(`You unequipped the ${item.name}.`);
            } else { // Equip the hook if owned but not equipped
                gameState.equippedHook = item.id;
                alert(`You equipped the ${item.name}!`);
            }
        } else if (item.type === 'rod') {
            const isEquipped = gameState.equippedRod === item.id;
            if (!hasItem) { // Buy the rod
                if (gameState.money >= item.price) {
                    gameState.money -= item.price;
                    gameState.ownedItems.push(item.id);
                    gameState.equippedRod = item.id; // Equip it automatically on purchase
                    alert(`You bought and equipped the ${item.name}!`);
                } else {
                    alert("Not enough money!");
                }
            } else if (isEquipped) { // Unequip if already equipped
                gameState.equippedRod = null;
                alert(`You unequipped the ${item.name}.`);
            } else { // Equip the rod if owned but not equipped
                gameState.equippedRod = item.id;
                alert(`You equipped the ${item.name}!`);
            }
        } 

        saveCollection();
        updateMoneyDisplay();
        updateBuyList(); // Refresh buy list (to update buttons)
        updateHookDisplay(); // Update equipment display on game screen
    }


    function updateCollection() {
      const list = document.getElementById("list");
      list.innerHTML = "";
      const collectedItemsCount = new Map();
      gameState.collection.forEach(item => {
          collectedItemsCount.set(item, (collectedItemsCount.get(item) || 0) + 1);
      });

      const sortedFishesInCollection = fishes.filter(f => collectedItemsCount.has(f.name))
                                             .sort((a, b) => b.stars - a.stars || a.rarity - b.rarity);

      if (sortedFishesInCollection.length === 0) {
          list.innerHTML = "<li>Your collection is empty! Go fishing!</li>";
          return;
      }

      sortedFishesInCollection.forEach(f => {
        const li = document.createElement("li");
        li.innerText = `${f.name} ${'★'.repeat(f.stars)} x${collectedItemsCount.get(f.name)}`;
        list.appendChild(li);
      });
    }

    function updateShopList() {
        const sellList = document.getElementById("sell-list");
        sellList.innerHTML = "";
        const collectedItemsCount = new Map();
        gameState.collection.forEach(item => {
            collectedItemsCount.set(item, (collectedItemsCount.get(item) || 0) + 1);
        });

        const sellableItems = fishes.filter(f => collectedItemsCount.has(f.name) && f.price > 0)
                                    .sort((a, b) => b.stars - a.stars || a.rarity - b.rarity);

        if (sellableItems.length === 0) {
            sellList.innerHTML = "<li>Nothing to sell! Go fishing!</li>";
            return;
        }

        sellableItems.forEach(f => {
            const count = collectedItemsCount.get(f.name);
            const itemId = f.name.replace(/[^a-zA-Z0-9]/g, '');
            const li = document.createElement("li");
            li.innerHTML = `
                <span>${f.name} ${'★'.repeat(f.stars)} x${count} - $${f.price} each</span>
                <input type="number" id="qty-${itemId}" value="1" min="1" max="${count}" style="width: 50px;">
                <button onclick="sellItem('${f.name}', 'qty-${itemId}')">Sell</button>
            `;
            sellList.appendChild(li);
        });
    }

    function updateBuyList() {
        const buyList = document.getElementById("buy-list");
        buyList.innerHTML = "";

        // Option to unequip hook
        const liNoHook = document.createElement('li');
        const noHookEquipped = (gameState.equippedHook === null);
        liNoHook.innerHTML = `
            <span class="item-info-container">
                <span>No Hook Equipped</span>
                <span>${TEXT_LABELS.NO_HOOK_DESC}</span>
            </span>
            <div class="item-action">
                <span>-</span>
                <button onclick="handleItemAction('no_hook')" ${noHookEquipped ? 'disabled' : ''}>
                    ${noHookEquipped ? TEXT_LABELS.EQUIPPED : TEXT_LABELS.UNEQUIP}
                </button>
            </div>
        `;
        buyList.appendChild(liNoHook);

        // Option to unequip rod
        const liNoRod = document.createElement('li');
        const noRodEquipped = (gameState.equippedRod === null);
        liNoRod.innerHTML = `
            <span class="item-info-container">
                <span>No Rod Equipped</span>
                <span>${TEXT_LABELS.NO_ROD_DESC}</span>
            </span>
            <div class="item-action">
                <span>-</span>
                <button onclick="handleItemAction('no_rod')" ${noRodEquipped ? 'disabled' : ''}>
                    ${noRodEquipped ? TEXT_LABELS.EQUIPPED : TEXT_LABELS.UNEQUIP}
                </button>
            </div>
        `;
        buyList.appendChild(liNoRod);


        // Filter shopItems to only include 'hook' and 'rod' types
        const purchasableItems = shopItems.filter(item => item.type === 'hook' || item.type === 'rod');

        purchasableItems.forEach(item => {
            const li = document.createElement("li");
            const hasItem = gameState.ownedItems.includes(item.id);
            const canAfford = gameState.money >= item.price;

            let buttonText = "Buy";
            let isDisabled = false;
            
            if (item.type === 'hook') {
                const isEquipped = gameState.equippedHook === item.id;
                if (isEquipped) {
                    buttonText = TEXT_LABELS.EQUIPPED;
                } else if (hasItem) {
                    buttonText = TEXT_LABELS.EQUIP;
                } else if (!canAfford) {
                    buttonText = TEXT_LABELS.TOO_EXPENSIVE;
                    isDisabled = true;
                }
            } else if (item.type === 'rod') {
                const isEquipped = gameState.equippedRod === item.id;
                if (isEquipped) {
                    buttonText = TEXT_LABELS.EQUIPPED;
                } else if (hasItem) {
                    buttonText = TEXT_LABELS.EQUIP;
                } else if (!canAfford) {
                    buttonText = TEXT_LABELS.TOO_EXPENSIVE;
                    isDisabled = true;
                }
            }
            
            li.innerHTML = `
                <span class="item-info-container">
                    <span>${item.name}</span>
                    <span>${item.description}</span>
                </span>
                <div class="item-action">
                    <span>$${item.price}</span>
                    <button ${isDisabled ? 'disabled' : ''} onclick="handleItemAction('${item.id}')">
                        ${buttonText}
                    </button>
                </div>
            `;
            buyList.appendChild(li);
        });
    }

    function updateHookDisplay() {
        const currentHookDisplay = document.getElementById('current-hook');
        if (gameState.equippedHook) {
            const hook = shopItems.find(h => h.id === gameState.equippedHook && h.type === 'hook');
            currentHookDisplay.innerText = hook ? hook.name : 'None';
        } else {
            currentHookDisplay.innerText = 'None';
        }

        const currentRodDisplay = document.getElementById('current-rod');
        if (gameState.equippedRod) {
            const rod = shopItems.find(r => r.id === gameState.equippedRod && r.type === 'rod');
            currentRodDisplay.innerText = rod ? rod.name : 'None';
        } else {
            currentRodDisplay.innerText = 'None';
        }
        saveCollection(); // Save equipment state
    }

    function saveCollection() {
      localStorage.setItem("fishingCollection", JSON.stringify(gameState.collection));
      localStorage.setItem("fishingXP", JSON.stringify({ 
          xp: gameState.xp, 
          level: gameState.level, 
          money: gameState.money, 
          ownedItems: gameState.ownedItems, 
          equippedHook: gameState.equippedHook, 
          equippedRod: gameState.equippedRod 
      }));
    }

    function loadCollection() {
      const data = localStorage.getItem("fishingCollection");
      if (data) gameState.collection = JSON.parse(data);
      const xpData = JSON.parse(localStorage.getItem("fishingXP"));
      if (xpData) {
        gameState.xp = xpData.xp;
        gameState.level = xpData.level;
        gameState.money = xpData.money || 0;
        gameState.ownedItems = xpData.ownedItems || []; 
        gameState.equippedHook = xpData.equippedHook || null;
        gameState.equippedRod = xpData.equippedRod || null; 
      }
      updateCollection();
      updateXpLevelDisplay();
      updateMoneyDisplay();
      updateHookDisplay(); 
    }

    function resetGame() {
      if (confirm("Are you sure you want to reset all your progression? This action cannot be undone.")) {
        localStorage.removeItem("fishingCollection");
        localStorage.removeItem("fishingXP");
        gameState.collection = [];
        gameState.xp = 0;
        gameState.level = 1;
        gameState.money = 0;
        gameState.ownedItems = [];
        gameState.equippedHook = null;
        gameState.equippedRod = null;
        updateCollection();
        updateXpLevelDisplay();
        updateMoneyDisplay();
        updateHookDisplay(); 
        alert("Your progression has been reset!");
        showMenu();
      }
    }

    // Initializing ambient bubbles
    for (let i = 0; i < 30; i++) {
      const b = document.createElement("div");
      b.className = "bubble";
      b.style.left = Math.random() * 100 + "vw";
      b.style.animationDuration = (6 + Math.random() * 6) + "s";
      b.style.width = b.style.height = (5 + Math.random() * 10) + "px";
      document.body.appendChild(b);
    }

    // Show menu on initial load
    document.addEventListener('DOMContentLoaded', () => {
        showMenu(); 
        loadCollection(); 
    });
  </script>
</body>
</html>
